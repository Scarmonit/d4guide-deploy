name: Update D4 API Data

on:
  schedule:
    # Run Monday and Thursday at 9:00 AM UTC to catch meta changes
    - cron: "0 9 * * 1,4"
  workflow_dispatch:
    inputs:
      scripts:
        description: 'Which scripts to run (all, maxroll-builds, tierlist, d4data, maxroll, builds)'
        required: false
        default: 'all'

jobs:
  update-data:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install wrangler
        run: npm install -g wrangler

      - name: Run data ingestion
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_D1_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          D1_DATABASE_ID: ${{ secrets.D1_DATABASE_ID }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          USE_WRANGLER: "1"
        run: |
          SCRIPT="${{ github.event.inputs.scripts || 'all' }}"

          if [ "$SCRIPT" = "all" ]; then
            node scripts/ingest.js
          elif [ "$SCRIPT" = "maxroll-builds" ]; then
            node scripts/ingest-maxroll-builds.js
          elif [ "$SCRIPT" = "tierlist" ]; then
            node scripts/ingest-tierlist.js
          elif [ "$SCRIPT" = "d4data" ]; then
            node scripts/ingest-d4data.js
          elif [ "$SCRIPT" = "maxroll" ]; then
            node scripts/ingest-maxroll.js
          elif [ "$SCRIPT" = "builds" ]; then
            node scripts/ingest-builds.js
          else
            echo "Unknown script: $SCRIPT"
            exit 1
          fi

      - name: Verify data
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_D1_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "Verifying D1 database tables..."
          wrangler d1 execute d4-api --remote --command "SELECT 'tier_list' as tbl, COUNT(*) as count FROM tier_list UNION ALL SELECT 'builds', COUNT(*) FROM builds;"
